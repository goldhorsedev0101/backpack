<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>GlobeMate — Collector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }
    #map { height: calc(100% - 64px); }
    .topbar {
      height: 64px; padding: 8px 12px; display: flex; gap: 8px; align-items: center;
      border-bottom: 1px solid #eee;
    }
    #search { flex: 1; padding: 10px 12px; font-size: 16px; }
    #export { padding: 10px 14px; cursor: pointer; }
    .pill { font-size: 12px; background: #f4f4f4; padding: 4px 8px; border-radius: 12px; }
  </style>

  <!-- Maps JS עם מפתח מהשרת -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key={{ browser_key }}&libraries=places&callback=initMap">
  </script>
</head>
<body>
  <div class="topbar">
    <span class="pill">GlobeMate</span>
    <input id="search" placeholder="חפש מקום: 'hostel cusco' / 'surf camp lima'..." />
    <button id="export">ייצוא JSON</button>
    <button id="save">שמור ל-DB</button>
  </div>
  <div id="map"></div>

  <script>
    let map, autocomplete, markers = [];
    const collectedPlaces = new Map(); // key: place_id → value: normalized object

    window.initMap = function() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 40.1215, lng: -100.4504 }, zoom: 4
      });

      const input = document.getElementById("search");
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["place_id","name","formatted_address","geometry","rating","types","url"],
      });
      autocomplete.bindTo("bounds", map);

      autocomplete.addListener("place_changed", async () => {
        const place = autocomplete.getPlace();
        if (!place || !place.geometry) return;

        map.panTo(place.geometry.location);
        map.setZoom(14);

        const marker = new google.maps.Marker({
          map, position: place.geometry.location, title: place.name
        });
        markers.push(marker);

        const normalized = {
          source: "google_places_js",
          place_id: place.place_id,
          name: place.name || null,
          address: place.formatted_address || null,
          lat: place.geometry.location.lat(),
          lng: place.geometry.location.lng(),
          rating: place.rating ?? null,
          types: place.types || [],
          url: place.url || null,
          collected_at: new Date().toISOString()
        };
        collectedPlaces.set(place.place_id, normalized);

        // פרטים עשירים מהשרת (לא חושפים מפתח שרת)
        try {
          const resp = await fetch(`/api/place-details?place_id=${encodeURIComponent(place.place_id)}`);
          if (resp.ok) {
            const details = await resp.json();
            collectedPlaces.set(place.place_id, { ...normalized, ...details });
          }
        } catch (e) {
          console.warn("Server details fetch failed:", e);
        }
      });

      document.getElementById("export").addEventListener("click", () => {
        const data = Array.from(collectedPlaces.values());
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = Object.assign(document.createElement("a"), { href: url, download: "places_export.json" });
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById("save").addEventListener("click", async () => {
        const data = Array.from(collectedPlaces.values());
        if (!data.length) { alert("אין נתונים לשמירה"); return; }
        try {
          const resp = await fetch("/api/save-places", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
          });
          const res = await resp.json();
          if (!resp.ok) throw new Error(JSON.stringify(res));
          alert(`נשמרו ${res.saved_places} מקומות ל-DB`);
        } catch (e) {
          alert("שמירה נכשלה: " + e.message);
        }
      });
    };
  </script>
</body>
</html>