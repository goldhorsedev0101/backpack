×‘×™×§×•×¨×•×ª â€” ×™×¦×™×¨×”, ×ª×¦×•×’×”, ×¢×¨×™×›×”/××—×™×§×”, â€œHelpfulâ€, ×ª××•× ×•×ª, ×¡×™× ×•×Ÿ ×•-Guest Mode

×¢×“×›×Ÿ ××ª ×˜××‘ â€œPlace Reviewsâ€ ×‘Ö¾/community ×›×š:

1) ××•×“×œ × ×ª×•× ×™× (×”×ª×××” ×¨×›×”, ×‘×œ×™ ×œ×©×‘×•×¨ ×§×™×™×)

×”×©×ª××© ×‘Ö¾public.place_reviews (×™×© ×›×‘×¨ × ×ª×•× ×™×). ×”× ×— ×©×“×•×ª ××¤×©×¨×™×™×:

id uuid pk, entity_type text, entity_id uuid, rating int, title text, body text,
author_name text null, user_id uuid null, created_at timestamptz, updated_at timestamptz
×˜×‘×œ×ª ×¢×–×¨ ×—×“×©×” (×× ×œ× ×§×™×™××ª â€” ×¨×§ ×¡×¤×§ SQL ×‘×§×•×‘×¥, ×œ× ×œ×”×¨×™×¥ ××•×˜×•××˜×™×ª):

public.place_review_votes (×œÖ¾â€œHelpfulâ€):

id uuid pk default gen_random_uuid()

review_id uuid not null

user_id uuid null

guest_token text null -- ×œ×–×™×”×•×™ ××¦×‘×™×¢×™ ××•×¨×— (×©××™×¨×” ×‘-localStorage)

is_helpful boolean not null default true

created_at timestamptz default now()

××™× ×“×§×¡×™×: ×¢×œ (review_id), ×•×¢×œ (review_id,user_id/guest_token) ×™×™×—×•×“×™ ×¨×•×¤×£ ×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª.

×× ×©×“×•×ª ××¡×•×™××™× ×œ× ×§×™×™××™× ××¦×œ×š â€” ×“×œ×’ ×‘×©×§×˜ (××œ ×ª×§×¨×™×¡). ×”Ö¾UI ×¦×¨×™×š ×œ×”×ª××™× ××ª ×¢×¦××• ××•×˜×•××˜×™×ª ×œ××” ×©×§×™×™×.

2) UI ×¨××©×™ â€” ×¨×©×™××ª ×‘×™×§×•×¨×•×ª

Toolbar ×¢×œ×™×•×Ÿ:

×—×™×¤×•×© ×—×•×¤×©×™ (title/body ilike)

×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’ ×™×©×•×ª: All | Destinations | Accommodations | Attractions | Restaurants

×¡×™× ×•×Ÿ ×“×™×¨×•×’ ××™× ×™××œ×™ (1â€“5)

××™×•×Ÿ: Newest (×‘×¨×™×¨×ª ××—×“×œ), Top Rated, Lowest Rated, Most Helpful

×›×¤×ª×•×¨ Write a Review (×¤×ª×— ××•×“×œ ×™×¦×™×¨×”)

×¨×©×™××ª ×‘×™×§×•×¨×•×ª ×¢× ×¢×™××•×“ (20 ×œ×¢××•×“), ××¦×‘ ×¨×™×§ ×™×“×™×“×•×ª×™.

×›×¨×˜×™×¡ ×‘×™×§×•×¨×ª (ReviewCard):

×›×•×ª×¨×ª, â­â­â­â­â­ (×ª××™×›×” ×‘×—×¦××™ ×›×•×›×‘ ×× ×™×©), ×©× ×”××§×•× + Chip ×¡×•×’ ×”×™×©×•×ª,

×©× ×›×•×ª×‘ (××• â€œGuestâ€), ×–××Ÿ ×™×—×¡×™ + Tooltip ×–××Ÿ ××œ×,

×’×•×£ ××§×•×¦×¨ (3â€“4 ×©×•×¨×•×ª) ×¢× â€œShow more / lessâ€,

Thumbnail ×©×œ ×”××§×•× ×Ö¾location_photos (×œ×œ× N+1 â€” ×¨××” Â§5),

×©×•×¨×ª ×¤×¢×•×œ×•×ª:

â€œHelpfulâ€ (ğŸ‘) ×¢× ××•× ×” (××¡â€™ ×”×¦×‘×¢×•×ª ×™×™×—×•×“×™×•×ª) â€” Toggle,

â€œEditâ€ / â€œDeleteâ€ â€” ××•×¦×’×™× ×¨×§ ×œ×‘×¢×œ ×”×¨×©×•××” (Auth: user_id===auth.uid(); Guest: author_name===guest_name ×›-fallback),

â€œReportâ€ (×œ×—×¦×Ÿ UI ×‘×œ×‘×“, ×œ×œ× ×©×¨×ª),

×œ×—×™×¦×” ×¢×œ ×©×/×ª××•× ×” â†’ × ×™×•×•×˜ ×œÖ¾/explore?tab=<type>&q=<name>.

3) ×™×¦×™×¨×ª ×‘×™×§×•×¨×ª â€” Write a Review

Modal ×˜×•×¤×¡:

Select Place:

×‘×—×¨ ×¡×•×’ ×™×©×•×ª (Destination/Accommodation/Attraction/Restaurant),

Auto-complete ×¢×œ ×©× (ilike) ××”×˜×‘×œ×” ×”××ª××™××”, ×¢× ×¢×™××•×“ ×§×˜×Ÿ ×•-debounce,

Rating (1â€“5) â€” ×—×•×‘×”,

Title (4â€“80) â€” ×—×•×‘×”,

Review (body) (20â€“2000) â€” ×—×•×‘×”,

Your name â€” ×—×•×‘×” ×‘××¦×‘ ××•×¨×—; × ×©××¨ ×‘-localStorage ×›-guest_name.

Submit:

await supabase.from('place_reviews').insert([{
  entity_type, entity_id, rating, title, body,
  ...(hasCol('user_id') ? { user_id: auth?.user()?.id ?? null } : {}),
  ...(hasCol('author_name') ? { author_name: currentDisplayNameOrGuest } : {})
}]).select().single();


Optimistic UI + Toasts; ×—×¡×™××ª Spam ×§×œ×”: debounce + ×× ×¢ multi-submit.

4) ×¢×¨×™×›×”/××—×™×§×” ×©×œ ×‘×™×§×•×¨×ª

â€œEditâ€ ×¤×•×ª×—Modal ×¢×¨×™×›×” ×¢× ×©×“×•×ª: Rating/Title/Body (×œ× ××©× ×™× ××§×•×).

Guard ×”×¨×©××•×ª ×‘×¦×“ ×œ×§×•×—:

Auth: user_id === auth.uid()

Guest: author_name === guest_name (×× ×–×” ×”××•×“×œ ××¦×œ×š)

Update:

await supabase.from('place_reviews')
  .update({ rating, title, body, ...(hasCol('updated_at') ? { updated_at: new Date().toISOString() } : {}) })
  .eq('id', reviewId)
  .select().single();


Delete:

await supabase.from('place_reviews').delete().eq('id', reviewId);


UI: Toast ×”×¦×œ×—×”/×©×’×™××”, ×”×¡×¨×” ××”×¨×©×™××”/×¨×¢× ×•×Ÿ.

5) ×ª××•× ×•×ª ×œ×œ× N+1 + ×××•×¦×¢×™×

×œ××—×¨ ×©×œ×™×¤×ª ×¢××•×“ ×‘×™×§×•×¨×•×ª:

××¡×•×£ pairs = [{ entity_type, entity_id }] (×™×™×—×•×“×™×™×),

×ª××•× ×•×ª: ×‘×¦×¢ ×§×¨×™××” ××—×ª (××• 4 ×‘×§×‘×•×¦×•×ª ×œ×¤×™ type) ×œÖ¾location_photos
×¢× eq('entity_type', <type>) + in('entity_id', ids) + order('inserted_at desc'),
×‘×—×¨ ×œ×›×œ id thumbnail_url ?? url.

Aggregates (×××•×¦×¢/××•× ×”): ×‘×§×©×” ××§×•×‘×¦×ª ×œÖ¾place_reviews:
select('entity_type,entity_id, avg(rating), count:id') ×¢× in(entity_id, ...) ×œ×¤×™ type,
×”×¦×’ â€œâ˜… {avg.toFixed(1)} Â· {count} reviewsâ€ (×“×œ×’ ×× ××™×Ÿ).

6) â€œHelpfulâ€ Votes

×–×™×”×•×™ ××¦×‘×™×¢:

Auth: user_id

Guest: ×”×¤×§ guest_token (UUID) ×•×©××•×¨ ×‘-localStorage; ×©×œ×— ×‘×‘×§×©×•×ª ×”×”×¦×‘×¢×”.

×¤×¢×•×œ×ª Toggle:

×‘×“×•×§ ×× ×§×™×™××ª ×”×¦×‘×¢×” ×œ××•×ª×• (review_id, user_id/guest_token):

×× ×§×™×™××ª â†’ ××—×§ (×‘×˜×œ Helpful)

×× ×œ× â†’ ×”×›× ×¡ ×©×•×¨×” ×—×“×©×” ×¢× is_helpful=true

××•× ×” Helpful:

×‘×§×©×ª count ×™×¢×™×œ×” (select('review_id', { count: 'exact', head: true }) ×¢× ×¡×™× ×•×Ÿ), ××• ×©××•×¨ cache ××—×¨×™ ×¤×¢×•×œ×”.

UI: ×›×¤×ª×•×¨ ğŸ‘ ××©× ×” ××¦×‘, ××•× ×” ××ª×¢×“×›×Ÿ ××™×™×“×™×ª (Optimistic).

7) ×‘×™×¦×•×¢×™×

×¢×™××•×“ .range(pageStart, pageEnd) (20 ×¤×¨×™×˜×™×),

×—×™×¤×•×©/×¡×™× ×•×Ÿ ×¢× ilike ×•-or() ××ª×•×Ÿ,

Cache ×§×¦×¨ (60 ×©× ×™×•×ª) ×œ××•×˜×•×§×•××¤×œ×™×˜,

××œ ×ª×‘×¦×¢ ×§×¨×™××•×ª ×ª××•× ×•×ª/××’×¨×’×¦×™×•×ª ×× ×”×¨×©×™××” ×¨×™×§×”.

8) Guest Mode + Auth

×× ××™×Ÿ Auth:

×•×“× ×©×™×© guest_name ×œ×¤× ×™ ×™×¦×™×¨×”/×¢×¨×™×›×”/××—×™×§×” (Prompt ×¢×“×™×Ÿ ×× ×—×¡×¨),

Helpful ××©×ª××© ×‘-guest_token (localStorage).

×× ×™×© Auth: ×”×¦×’ Avatar/×©×; ×”×’×‘×œ ×¢×¨×™×›×”/××—×™×§×” ×œ×‘×¢×œ×™× ×‘×œ×‘×“ (RLS ×‘-PROD).

9) RLS/Policies (××¡××›×™× ×‘×œ×‘×“ â€” ×œ× ×œ×”×¨×™×¥ ××•×˜×•××˜×™×ª)

×¢×“×›×Ÿ/×¦×•×¨ docs/community-rls.md ×¢× ××§×˜×¢×™ SQL:

place_reviews

DEV:

alter table public.place_reviews enable row level security;
create policy if not exists "public read place_reviews" on public.place_reviews for select using (true);
create policy if not exists "public write place_reviews" on public.place_reviews for insert with check (true);
-- ××•×¤×¦×™×•× ×œ×™ ×œ-DEV: ×¢×¨×™×›×”/××—×™×§×” ×—×•×¤×©×™×ª (×œ× ××•××œ×¥ ×œ×¤×¨×•×“×§×©×Ÿ)


PROD (××•××œ×¥):

select ×œ×›×•×œ×,

insert ×¨×§ user_id = auth.uid() ××• ××•×“×œ ××•×¨×— ××‘×•×§×¨ (×× ×™×© endpoint ×©×¨×ª),

update/delete ×¨×§ ×œ×‘×¢×œ×™× (user_id = auth.uid()).

place_review_votes

DEV: select/insert/delete ×¤×ª×•×—×™×,

PROD:

insert: ××•×ª×¨ ×œ×›×œ ××©×ª××© ××—×•×‘×¨; ×œ××•×¨×—×™× â€“ ×¨×§ ×“×¨×š ×¤×•× ×§×¦×™×™×ª RPC ××‘×•×§×¨×ª (××• ××“×™× ×™×•×ª ×©×××¤×©×¨×ª guest_token ×× ×‘×—×¨×ª ×œ×©××•×¨ ××•×ª×• ×‘×©×“×”),

delete: ×¨×§ ××™ ×©×”×¦×‘×™×¢ (user_id ××• guest_token ×ª×•××).

×”×•×¡×£ scripts/sql/create_place_review_votes.sql ×¢× ×™×¦×™×¨×ª ×”×˜×‘×œ×” + ××™× ×“×§×¡×™×.

10) ×—×™×‘×•×¨ ×œÖ¾/explore

ReviewCard: ×œ×—×™×¦×” ×¢×œ ×©× ×”××§×•×/Thumb:

× ×™×•×•×˜ ×œÖ¾/explore?tab=<type>&q=<placeName>

×©××•×¨ query string ×›×“×™ ×œ×˜×¢×•×Ÿ ××ª ××•×ª×• ××¦×‘.

11) ×§×‘×¦×™× / ×§×•××¤×•× × ×˜×™× (×”×ª×× ×œ××‘× ×” ××¦×œ×š)

src/components/community/ReviewsTab.tsx â€” ×œ×•×’×™×§×ª ×”×“×£, Toolbar, ×¢×™××•×“, ×˜×¢×™× ×•×ª

src/components/community/ReviewCard.tsx â€” ×ª×¦×•×’×ª ×‘×™×§×•×¨×ª + ×¤×¢×•×œ×•×ª (Helpful/Edit/Delete/Report)

src/components/community/WriteReviewModal.tsx â€” ×™×¦×™×¨×”

src/components/community/EditReviewModal.tsx â€” ×¢×¨×™×›×”

src/lib/reviewsApi.ts

listReviews(filters)

createReview(payload)

updateReview(id, payload)

deleteReview(id)

toggleHelpful(reviewId) (××—×œ×™×˜ Auth/Guest)

listPlacesForType(type, q)

fetchPhotosForEntities(pairs)

fetchAggregatesForEntities(pairs)

scripts/sql/create_place_review_votes.sql

×¢×“×›×•×Ÿ docs/community-rls.md ×¢× ×”××“×™× ×™×•×ª ×œ×¢×™×œ.

12) ×§×‘×œ×” (Acceptance)

×˜××‘ Place Reviews ××¦×™×’ ×¨×©×™××ª ×‘×™×§×•×¨×•×ª ×¢× ×ª××•× ×•×ª (×œ×œ× N+1), ×—×™×¤×•×©/×¡×™× ×•×Ÿ/××™×•×Ÿ, ×•×¢×™××•×“.

Write a Review ×™×•×¦×¨ ×‘×™×§×•×¨×ª ×—×“×©×” (Auth/Guest), ××¨×¢× ×Ÿ ××ª ×”×¨×©×™××”, Toast ×”×¦×œ×—×”.

Edit/Delete ×–××™× ×™× ×œ×‘×¢×œ×™× ×‘×œ×‘×“, ×¤×•×¢×œ×™× ×¢× Toast×™×.

Helpful ×¢×•×‘×“ (Toggle), ××•× ×” ××ª×¢×“×›×Ÿ ××™×“.

×œ×—×™×¦×” ×¢×œ ×©×/×ª××•× ×” ××¢×‘×™×¨×” ×œÖ¾/explore ×¢× ×”×˜××‘/×—×™×¤×•×© ×”×¨×œ×•×•× ×˜×™.

××™×Ÿ ×”×§×©×—×ª ××¤×ª×—×•×ª; ×©×™××•×© ×¨×§ ×‘-ENV.

××™×Ÿ ×©×‘×™×¨×ª Tabs ××—×¨×™× ×‘Ö¾/community.

Commit ×‘×¡×™×•×:
feat(community): full reviews system â€” create, list, filter, edit/delete, helpful votes, photos batching, guest/auth support