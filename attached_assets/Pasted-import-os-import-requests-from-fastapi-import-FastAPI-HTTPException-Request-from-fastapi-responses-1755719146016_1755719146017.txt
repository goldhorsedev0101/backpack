import os
import requests
from fastapi import FastAPI, HTTPException, Request
from fastapi.responses import JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from fastapi.templating import Jinja2Templates
from fastapi.responses import HTMLResponse

# === הגדרות מפתחות מה-Secrets של Replit ===
GOOGLE_PLACES_KEY = os.getenv("GOOGLE_PLACES_KEY")   # מפתח שרת ל-Places API (מוגבל-API)
BROWSER_KEY = os.getenv("BROWSER_KEY")               # מפתח דפדפן ל-Maps JS (מוגבל דומיין)

if not GOOGLE_PLACES_KEY:
    raise RuntimeError("GOOGLE_PLACES_KEY חסר ב-Secrets של Replit")
if not BROWSER_KEY:
    raise RuntimeError("BROWSER_KEY חסר ב-Secrets של Replit")

app = FastAPI(title="TripWise Collector")

# אם תריץ פרונט נפרד – השאר CORS. כרגע לא חובה כי הכל באותו שרת.
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # אפשר לצמצם לדומיין של ה-Repl שלך
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# סטטיים + תבניות
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")

# עמוד הבית – מגיש index.html ומזריק את מפתח ה-BROWSER_KEY לסקריפט של המפה
@app.get("/", response_class=HTMLResponse)
def home(request: Request):
    return templates.TemplateResponse(
        "index.html",
        {"request": request, "browser_key": BROWSER_KEY}
    )

# === Places Details API (שרת) ===
FIELDS = ",".join([
    "id",
    "displayName",
    "formattedAddress",
    "internationalPhoneNumber",
    "rating",
    "userRatingCount",
    "websiteUri",
    "location",
    "currentOpeningHours",
    "editorialSummary",
    "reviews"
])

@app.get("/api/place-details")
def place_details(place_id: str):
    url = f"https://places.googleapis.com/v1/places/{place_id}"
    headers = {
        "X-Goog-Api-Key": GOOGLE_PLACES_KEY,
        "X-Goog-FieldMask": FIELDS
    }
    r = requests.get(url, headers=headers, timeout=15)
    if r.status_code != 200:
        raise HTTPException(status_code=r.status_code, detail=r.text)

    p = r.json()
    out = {
        "name": (p.get("displayName") or {}).get("text"),
        "address": p.get("formattedAddress"),
        "phone": p.get("internationalPhoneNumber"),
        "rating": p.get("rating"),
        "reviews_count": p.get("userRatingCount"),
        "website": p.get("websiteUri"),
        "lat": (p.get("location") or {}).get("latitude"),
        "lng": (p.get("location") or {}).get("longitude"),
        "opening_hours": (p.get("currentOpeningHours") or {}).get("weekdayDescriptions"),
        "summary": (p.get("editorialSummary") or {}).get("text"),
        "reviews": [
            {
                "rating": rv.get("rating"),
                "text": (rv.get("text") or {}).get("text"),
                "publishTime": rv.get("publishTime"),
                "authorAttribution": (rv.get("authorAttribution") or {}).get("displayName")
            } for rv in p.get("reviews", [])
        ]
    }
    return JSONResponse(out)